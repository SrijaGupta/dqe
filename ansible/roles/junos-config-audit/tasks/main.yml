---
###################################################################################
#
# Copyright 2020 Juniper Networks, Inc. All rights reserved.
# Licensed under the Juniper Networks Script Software License (the "License").
# You may not use this script file except in compliance with the License, which is 
# located at http://www.juniper.net/support/legal/scriptlicense/
# Unless required by applicable law or otherwise agreed to in writing by the 
# parties, software distributed under the License is distri buted on an 
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express 
# or implied.
#
##################################################################################
#
# Author        : Subrata Mazumdar, Juniper Networks Professional Services
# Contact       : subratam@juniper.net
# Company       : Juniper Networks
#
#
# Description   : 
#
#
# tasks file for junos-config-audit 

- name: Compare pre/post snapshots
  juniper_junos_jsnapy:
    host: "{{ device_ip }}"
    user: "{{ juniper_user | default('root') }}"
    passwd: "{{ juniper_password | default('Embe1mpls', true)}}"
    ssh_keyfile: "{{ juniper_key }}" 
    action: "check"
    dir: "{{ jsnapy_test_file_dir_path }}"
    logdir: "{{ jsnapy_log_dir_path }}"
    # config_file: "{{ jsnapy_config_audit_conf_file  }}"
    test_files: "{{ jsnapy_config_audit_test_file }}"
  register: jsnapy_check_result


- name: Dump jsnapy_check_result
  when: false
  debug: 
    msg: "device_ip: {{ device_ip }} jsnapy_check_result: {{ jsnapy_check_result }} "
  tags:
    - debug

- name: set snap-check results file path 
  copy: 
    content: "{{ jsnapy_check_result | to_nice_json }}"
    dest: "{{ jsnapy_snapcheck_results_file_path }}"
    mode: '0644'
  when: jsnapy_save_snap_check_result 
  vars: 
    jsnapy_snapcheck_results_file_path: "{{ jsnapy_snapcheck_dir_path }}/{{device_ip }}_CHECK_results.json"

- name: set snap-check results for reference host 
  set_fact: 
    junos_config_audit_results_flat: "{{ junos_config_audit_results_flat | combine({ device_ip : jsnapy_check_result}) }}"
    # junos_config_audit_results_flat: "{{ junos_config_audit_results_flat | combine( {(device_ip + '_'+ device_ip) : jsnapy_check_result }) }}"

